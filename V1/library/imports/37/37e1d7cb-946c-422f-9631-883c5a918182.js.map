{"version":3,"sources":["assets\\scripts\\Games\\eliminating\\script\\Eliminating.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\r\n//  - https://docs.cocos.com/creator/manual/en/scripting/typescript.html\r\n// Learn Attribute:\r\n//  - https://docs.cocos.com/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - https://docs.cocos.com/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nimport EliminatingBlock from './EliminatingBlock';\r\nimport Service from './Service';\r\nimport Map from './Map';\r\nimport EliminatingInterface from '../../../interface/game/eliminating';\r\nimport Block from './Block';\r\nimport State from '../../../utils/state';\r\nconst { ccclass, property } = cc._decorator;\r\n/**\r\n * 消消乐游戏场景类\r\n */\r\n@ccclass\r\nexport default class Eliminating extends cc.Component {\r\n\r\n    // 方格容器\r\n    @property(cc.Node) blockBox: cc.Node = null;\r\n    // 地图容器\r\n    @property(cc.Node) mapBox: cc.Node = null;\r\n    // 地图格资源\r\n    @property(cc.Prefab) mapPrefab: cc.Prefab = null;\r\n    // 方格资源\r\n    @property(cc.Prefab) block: cc.Prefab = null;\r\n    // 触摸位置存储\r\n    touch = {\r\n        x: -1,\r\n        y: -1,\r\n    };\r\n    // 当前目标方格\r\n    currentBlock: Block;\r\n    // 横轴可放置点数\r\n    // transverseCount = 4;\r\n    // 地图\r\n    Map: Map;\r\n    // 是否正在交换\r\n    exchanging = false;\r\n\r\n    start() {\r\n        // 为方格容器添加触摸事件\r\n        this.blockBox.on(cc.Node.EventType.TOUCH_START, this.TOUCH_START, this);\r\n        this.blockBox.on(cc.Node.EventType.TOUCH_END, this.TOUCH_END, this);\r\n\r\n        // 生成随机性的地图\r\n        const MapClass = Service.randomCreate(5, 11, {\r\n            mapBox: this.mapBox,\r\n            blockPrefab: this.block,\r\n            mapPrefab: this.mapPrefab,\r\n            blockBox: this.blockBox,\r\n        });\r\n        \r\n        State.tips('消消乐功能正在开发和完善!', 5, false, 2)\r\n\r\n        // MapClass.data.forEach((yItem, y) => {\r\n        //     yItem.forEach((xItem, x) => this.createMapScript(++index, x, y, xItem));\r\n        //     MapClass.MapScript = this.blocks;\r\n        // });\r\n        this.Map = MapClass;\r\n    }\r\n\r\n\r\n    /**\r\n     * 触摸开始\r\n     */\r\n    TOUCH_START(event) {\r\n        if (this.exchanging) return false;\r\n        const { touch } = this;\r\n        const { target } = event;\r\n        let { x, y } = event.touch._point;\r\n        touch.x = x -= target.x;\r\n        touch.y = y -= target.y;\r\n        this.currentBlock = this.targetBlock(touch.x, touch.y);\r\n    }\r\n\r\n\r\n    /**\r\n     * 触摸结束\r\n     */\r\n    async TOUCH_END(event) {\r\n        if (this.exchanging) return false;\r\n\r\n        const { touch } = this;\r\n        const { target } = event;\r\n        let { x, y } = event.touch._point;\r\n        x -= target.x;\r\n        y -= target.y;\r\n\r\n        // 移动方向参数计算\r\n        const absX = Math.abs(touch.x - x);\r\n        const absY = Math.abs(touch.y - y);\r\n        const move: any = {\r\n            x: absX > absY ? touch.x - x : 0,\r\n            y: absY > absX ? touch.y - y : 0,\r\n        };\r\n\r\n\r\n        // 执行移动操作\r\n        const prevBlock = this.currentBlock.index.split('-');\r\n        const [prevY, prevX] = prevBlock;\r\n        const targetBlock = this.Map.isAllowMove(\r\n            Number(prevY),\r\n            Number(prevX),\r\n            {\r\n                ...move,\r\n                top: move.y < 0,\r\n                bottom: move.y > 0,\r\n                right: move.x < 0,\r\n                left: move.x > 0,\r\n            }\r\n        );\r\n\r\n        // 如果允许移动\r\n        if (targetBlock) {\r\n            const nextBlock = targetBlock.index.split('-');\r\n            const [nextY, nextX] = nextBlock;\r\n\t\t\tconst prev = this.Map.mapScript[prevY][prevX];\r\n\t\t\tthis.exchanging = true;\r\n\r\n            await this.Map.exchangeBlock(prev, targetBlock);\r\n\r\n            // 三连消除检测\r\n\t\t\tconst p1Query = this.eliminateCheck(Number(nextY), Number(nextX));\r\n\t\t\tconst p2Query = this.eliminateCheck(Number(prevY), Number(prevX));\r\n\t\t\tif (!p1Query && !p2Query) {\r\n\t\t\t\tawait this.Map.exchangeBlock(targetBlock, prev);\r\n\t\t\t} else {\r\n\t\t\t\tconst asynData = {};\r\n\t\t\t\tconst destroyBlocks = [...(p1Query.destoryBlock || []), ...(p2Query.destoryBlock || [])]\r\n\t\t\t\t\t.filter(item => {\r\n\t\t\t\t\t\tif (item && !asynData[item.index]) {\r\n\t\t\t\t\t\t\treturn asynData[item.index] = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t;\r\n\t\t\t\tawait this.destroyBlocks(destroyBlocks);\r\n\t\t\t\tawait this.Map.destoryFall();\r\n\t\t\t}\r\n\r\n\t\t\tthis.exchanging = false;\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * 定位block资源\r\n     * @param x x轴\r\n     * @param y y轴\r\n     */\r\n    targetBlock(x: number, y: number) {\r\n        const { mapScript } = this.Map;\r\n        let target: Block;\r\n        for (let i = 0, len = mapScript.length; i < len; i++) {\r\n            const currentBlock = mapScript[i];\r\n            for (const block of currentBlock) {\r\n                if (block) {\r\n                    if ((block.x < x && block.x + block.width > x) && (block.y > y && block.y - block.height < y)) {\r\n                        target = block;\r\n                        break;\r\n                    }\r\n                }\r\n                if (target) break;\r\n            }\r\n        }\r\n        return target;\r\n    }\r\n\r\n\r\n    /**\r\n     * 移动方块操作\r\n     */\r\n    moveBlock(moveInfo: EliminatingInterface.Point) {\r\n        const { currentBlock } = this;\r\n        if (!currentBlock) {\r\n            return false;\r\n        }\r\n        const point = currentBlock.toString().split('-');\r\n\r\n        // 方向动作操作\r\n        this.Map.moveAnimation(this.Map.mapScript[point[0]][point[1]], moveInfo);\r\n        this.currentBlock = null;\r\n        return true;\r\n    }\r\n\r\n\r\n    /**\r\n     * 消除检测 [检测四各方向是否达成三连消除条件]\r\n     * @param y 二维数组y轴\r\n     * @param x 二维数组x轴\r\n     */\r\n    eliminateCheck(y: number, x: number) {\r\n        const checkQuery = this.Map.checkLine(y, x);\r\n        return checkQuery.destoryBlock.length ? checkQuery : false;\r\n    }\r\n\r\n\r\n    /**\r\n     * 销毁方块\r\n     * @param blocks 方块合集\r\n     */\r\n    async destroyBlocks(blocks: any[]) {\r\n        if (blocks.length) {\r\n            // const hash = Math.random().toString(16).substr(-10);\r\n\t\t\t// 顺序销毁\r\n            // console.warn(`-> ${hash} : eliminateCheck`);\r\n            // for (const target of blocks) {\r\n            //     console.log({ blocks, target })\r\n            //     await this.Map.destoryBlock(0, 0, target, hash);\r\n            // }\r\n\t\t\t// console.log(`<- ${hash}`);\r\n\t\t\t// 同步销毁\r\n\t\t\tawait Promise.all(blocks.map(block => this.Map.destoryBlock(0, 0, block)));\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n\r\n    /**\r\n     * 返回首页\r\n     */\r\n    backHome() {\r\n        cc.director.loadScene('Home');\r\n    }\r\n}"]}