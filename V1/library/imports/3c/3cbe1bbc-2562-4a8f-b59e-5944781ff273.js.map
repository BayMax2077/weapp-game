{"version":3,"sources":["assets\\scripts\\perfab\\script\\signal.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/typescript.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html\r\n// Learn Attribute:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nconst {ccclass, property} = cc._decorator;\r\nimport { dateFrom } from '../../../scripts/lib/tool';\r\nimport State from '../../utils/state';\r\n\r\nlet prveStatus = 20;\r\nlet statusUpdateTime = 0;\r\nlet clock = 0;\r\n\r\n@ccclass\r\nexport default class Signal extends cc.Component {\r\n\r\n    /**\r\n     * WIFI 连接正常\r\n     */\r\n    @property(cc.SpriteFrame) wifiSuccessFrame: cc.SpriteFrame = null;\r\n\r\n    /**\r\n     * WIFI 连接警告\r\n     */\r\n    @property(cc.SpriteFrame) wifiErrorFrame: cc.SpriteFrame = null;\r\n\r\n    /**\r\n     * WIFI 连接断开\r\n     */\r\n    @property(cc.SpriteFrame) wifiUnLinkFrame: cc.SpriteFrame = null;\r\n\r\n    /**\r\n     * WIFI\r\n     */\r\n    @property(cc.Sprite) wifi: cc.Sprite = null;\r\n\r\n    /**\r\n     * 时间文字\r\n     */\r\n    @property(cc.Label) time: cc.Label = null;\r\n\r\n    /**\r\n     * 延迟文字\r\n     */\r\n    @property(cc.Label) signal: cc.Label = null;\r\n\r\n    /**\r\n     * 弹窗\r\n     */\r\n    @property(cc.Prefab) popupPrefab: cc.Prefab = null;\r\n\r\n    /**\r\n     * 弹窗实例\r\n     */\r\n    scriptPopup: any = null;\r\n\r\n    onLoad() {\r\n        this.watch();\r\n        cc.game.on('socketConnect', this.watch.bind(this));\r\n        // cc.game.on('serverClose', this.serverCloseEvent.bind(this));\r\n        console.log('signal loading ....');\r\n        const onLine = (content: string) => {\r\n            const popup = cc.instantiate(this.popupPrefab);\r\n            cc.director.getScene().addChild(popup);\r\n            const scriptPopup = popup.getComponent('popup');\r\n            scriptPopup.init(content);\r\n            clearInterval(clock);\r\n            scriptPopup.setEvent('close', () => {\r\n                localStorage.clear();\r\n                cc.director.loadScene('loginPage');\r\n            });\r\n        }\r\n\r\n        // 账号在线监测\r\n        cc.game.on('onLine', onLine);\r\n        console.log({online: State.io.online}, 1);\r\n        \r\n        // 提早得到在线通知时\r\n        if (State.io.online) onLine('当前账号已在\\n其他设备上登录!');\r\n    }\r\n\r\n    \r\n    /**\r\n     * 服务器关闭检测\r\n     */\r\n    // serverCloseEvent() {\r\n    //     const popup = cc.instantiate(this.popupPrefab);\r\n    //     cc.director.getScene().addChild(popup);\r\n    //     const scriptPopup = popup.getComponent('popup');\r\n    //     scriptPopup.init('服务器维护中...\\n请退至首页!');\r\n    //     scriptPopup.setEvent('success', () => {\r\n    //         cc.director.loadScene('loginPage');\r\n    //     });\r\n    //     clearInterval(clock);\r\n    // }\r\n\r\n\r\n    /**\r\n     * 监听数据回音事件\r\n     */\r\n    watch() {\r\n        clock && clearInterval(clock);\r\n        clock = setInterval(() => {\r\n            this.time.string = dateFrom('HH:mm');\r\n            State.io.emit('signal', '');\r\n            const time = Date.now();\r\n\r\n            if (statusUpdateTime === 0) {\r\n                console.log('retrun statusUpdateTime');\r\n                statusUpdateTime = Date.now();\r\n                return;\r\n            }\r\n            if (statusUpdateTime + (10 * 1000) < Date.now()) {\r\n                // 掉线二次检测\r\n                this.wifi.spriteFrame = this.wifiUnLinkFrame;\r\n                prveStatus = 2000;\r\n                this.unonline();\r\n                this.signal.string = '已掉线';\r\n            } else if (statusUpdateTime + (4 * 1000) < time) {\r\n                // 警告状态\r\n                this.wifi.spriteFrame = this.wifiErrorFrame;\r\n                prveStatus = 700 + (Math.random() * 300 >> 1);\r\n                this.signal.node.color = cc.color(255, 160, 36);\r\n                this.signal.string = prveStatus.toString();\r\n            }\r\n\r\n            // 颜色修改\r\n            if (prveStatus > 1000) {\r\n                this.signal.node.color = cc.color(197, 27, 6);\r\n            }\r\n        }, 1000);\r\n\r\n        // 延迟接收\r\n        State.io.on('signal', this.onSignal.bind(this));\r\n    }\r\n\r\n\r\n    /**\r\n     * 接收到延迟数据时\r\n     * @param signal - 延迟\r\n     */\r\n    onSignal(signal) {\r\n        if (typeof signal === 'number' && this.signal) {\r\n            statusUpdateTime = Date.now();\r\n            this.signal.string = signal + 'ms';\r\n            State.userInfo.signal = signal;\r\n            this.scriptPopup && this.scriptPopup.close();\r\n\r\n            // 状态正常恢复\r\n            if (prveStatus >= 500 && prveStatus <= 2000 && signal < 500) {\r\n                this.wifi.spriteFrame = this.wifiSuccessFrame;\r\n                this.signal.node.color = cc.color(30, 255, 127);\r\n            }\r\n\r\n            // 延迟状态\r\n            if (signal > 500 && signal < 1000) {\r\n                this.wifi.spriteFrame = this.wifiErrorFrame;\r\n                this.signal.node.color = cc.color(255, 160, 36);\r\n                prveStatus = signal;\r\n            }\r\n\r\n            // 掉线状态\r\n            if (signal > 1000) {\r\n                this.wifi.spriteFrame = this.wifiUnLinkFrame;\r\n                prveStatus = signal;\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * 掉线弹窗处理\r\n     */\r\n    unonline() {\r\n        if (!this.scriptPopup) {\r\n            console.log('与服务器失去连接');\r\n            const popup = cc.instantiate(this.popupPrefab);\r\n            cc.director.getScene().addChild(popup);\r\n            const scriptPopup = popup.getComponent('popup');\r\n            scriptPopup.init('与服务器失去连接!\\n重新连接中...');\r\n            scriptPopup.setEvent('close', () => {\r\n                this.scriptPopup = null;\r\n            });\r\n            this.scriptPopup = scriptPopup;\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * 销毁场景时进行清理\r\n     */\r\n    onDestroy() {\r\n        State.io.off('signal', this.onSignal.bind(this));\r\n        cc.game.off('socketConnect', this.watch.bind(this));\r\n        clock && clearInterval(clock);\r\n        statusUpdateTime = 0;\r\n    }\r\n\r\n    // update (dt) {}\r\n}\r\n"]}