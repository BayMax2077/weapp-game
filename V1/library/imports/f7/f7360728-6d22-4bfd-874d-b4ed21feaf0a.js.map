{"version":3,"sources":["assets\\scripts\\Home\\shop\\Shop.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/typescript.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html\r\n// Learn Attribute:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nimport axios from '../../utils/axiosUtils';\r\n// import State from '../../utils/state';\r\nimport { ShopMenu, ShopItem } from '../../interface/shop';\r\nimport State from '../../utils/state';\r\n\r\nconst {ccclass, property} = cc._decorator;\r\n\r\n@ccclass\r\nexport default class Activity extends cc.Component {\r\n    // 主盒子内容\r\n    @property(cc.Node) mainContent: cc.Node = null;\r\n    // 商品名\r\n    @property(cc.Label) shopName: cc.Label = null;\r\n    // 商品类型\r\n    @property(cc.Label) shopType: cc.Label = null;\r\n    // 商品价格\r\n    @property(cc.Label) shopPrice: cc.Label = null;\r\n    // 商品简介\r\n    @property(cc.Label) shopDesc: cc.Label = null;\r\n    // 商品图标\r\n    @property(cc.Sprite) shopIcon: cc.Sprite = null;\r\n    // 左侧内容盒子节点\r\n    @property(cc.Node) leftBoxContent: cc.Node = null;\r\n    // 内容可滚动区域\r\n    @property(cc.ScrollView) ScrollView: cc.ScrollView = null;\r\n    // 商城菜单列表prefab 资源\r\n    @property(cc.Prefab) ShopMenuListPrefab: cc.Prefab = null;\r\n    // 菜单物品资源\r\n    @property(cc.Prefab) shopItemPrefab: cc.Prefab = null;\r\n    // 弹窗资源\r\n    @property(cc.Prefab) popup: cc.Prefab = null\r\n    // 没有商品字样\r\n    @property(cc.Node) notGoods: cc.Node = null;\r\n\r\n    // 物品数据\r\n    shopItemData: cc.Node[] = [];\r\n    defaultTarget: string = '';\r\n\r\n    init(option: string) {\r\n        this.defaultTarget = option;\r\n    }\r\n\r\n\r\n    start() {\r\n        this.notGoods.active = false;\r\n        axios.api('shop_menu').then((data: ShopMenu[]) => {\r\n            // 当前左侧列表目标\r\n            let targetItem = null;\r\n            // 当前聚焦的物品\r\n            let focusItem = null;\r\n            data.forEach((item, index) => {\r\n                const prefab = cc.instantiate(this.ShopMenuListPrefab);\r\n                const prefabScript = prefab.getComponent('ListItem');\r\n                if (item.imgName) {\r\n                    item.sprite = `${State.OSS_BASE}/text/shop/${ item.imgName }.png`;\r\n                }\r\n                item.title = item.name;\r\n                prefab.y = (prefab.y - index * 50) - prefab.height;\r\n                this.leftBoxContent.addChild(prefab);\r\n                prefabScript.init(item, index, !0);\r\n                prefab.scale = .8;\r\n                // 左侧列表的点击事件处理\r\n                prefabScript.clickEvent = () => new Promise(async (resolve) => {\r\n                    this.ScrollView.scrollToTop();\r\n                    if (!item.content) {\r\n                        item.content = await axios.api('shop_menu_goods', {\r\n                            params: {\r\n                                menuId: item.id,\r\n                            },\r\n                        }).then((res) => res);\r\n                    }\r\n                    resolve(item);\r\n                    if (targetItem) targetItem.blur();\r\n                    targetItem = prefabScript;\r\n                    // 渲染\r\n                    const res = item.content;\r\n                    if (res instanceof Array) {\r\n                        const {\r\n                            mainContent,\r\n                            shopItemData,\r\n                            shopName,\r\n                            shopType,\r\n                            shopPrice,\r\n                            shopDesc,\r\n                            shopIcon,\r\n                        } = this;\r\n                        let offsetX = 0;\r\n                        const col = mainContent.width > 600 ? 5 : 4;\r\n                        res.forEach((item, index) => {\r\n                            if (index % col === 0) {\r\n                                offsetX = 0;\r\n                            }\r\n                            offsetX++;\r\n                            if (shopItemData[index]) {\r\n                                // 重复渲染时重新初始化\r\n                                shopItemData[index].getComponent('shopItem').init(item);\r\n                                shopItemData[index].active = true;\r\n                            } else {\r\n                                const shopItemPrefab = cc.instantiate(this.shopItemPrefab);\r\n                                mainContent.addChild(shopItemPrefab);\r\n                                const shopItemScript = shopItemPrefab.getComponent('shopItem')\r\n                                shopItemScript.init(item);\r\n                                shopItemPrefab.x = (mainContent.width / col) * offsetX - 80;\r\n                                shopItemPrefab.y = -Math.round(index / col | 0) * 200 - 100;\r\n                                shopItemData.push(shopItemPrefab);\r\n                                shopItemScript.parentClass = this;\r\n                                // 商品点击事件\r\n                                shopItemScript.clickEvent = (data) => {\r\n                                    focusItem && focusItem.blur();\r\n                                    shopItemScript.focus();\r\n                                    focusItem = shopItemScript;\r\n                                    shopName.string = data.name;\r\n                                    shopType.string = '全部';\r\n                                    shopPrice.string = data.price;\r\n                                    shopDesc.string = data.desc;\r\n                                    shopIcon.spriteFrame = shopItemScript.icon.spriteFrame; \r\n                                }\r\n                            }\r\n                            // // 点击第一个\r\n                            // if (index === 0) {\r\n                            //     shopItemData[0] && shopItemData[0].getComponent('shopItem').onClick();\r\n                            // }\r\n                        });\r\n\r\n                        // 重渲染 多余数据隐藏\r\n                        if (res.length < shopItemData.length) {\r\n                            for (let i = res.length, len = shopItemData.length; i < len; i++) {\r\n                                shopItemData[i].active = false;\r\n                            }\r\n                        }\r\n\r\n                        this.notGoods.active = !res.length ? true : false;\r\n                    }\r\n                })\r\n\r\n                // 默认点击第一个\r\n                if (this.defaultTarget) {\r\n                    if (this.defaultTarget == item.name) prefabScript.onClick();\r\n                } else if (index === 0) prefabScript.onClick();\r\n            });\r\n        });\r\n    }\r\n\r\n\r\n    /**\r\n     * 购买商品时\r\n     * @param goodsData - 商品数据\r\n     */\r\n    buyGoods(goodsData) {\r\n        const popup = cc.instantiate(this.popup);\r\n        const scriptPopup = popup.getComponent('popup');\r\n        cc.director.getScene().addChild(popup);\r\n        \r\n        scriptPopup.init(`将使用 ${goodsData.price + goodsData.bay_currency_name} 购买,\\n[ ${goodsData.name} ]\\n是否确定?`);\r\n        scriptPopup.setEvent('success', () => {\r\n            scriptPopup.message('支付中...');\r\n            scriptPopup.setEvent('success', null);\r\n            scriptPopup.setEvent('close', null);\r\n            axios\r\n                .api('shop_buy', {\r\n                    params: {\r\n                        goodsId: goodsData.id,\r\n                    },\r\n                })\r\n                .then((query) => {\r\n                    if(query.status) {\r\n                        scriptPopup.message(`支付成功!获得\\n[ ${goodsData.name} ]`);\r\n                        cc.game.emit('updateUserData');\r\n                    } else {\r\n                        scriptPopup.message('支付失败!\\n' + query.msg);\r\n                    }\r\n                    scriptPopup.setEvent('success', () => {\r\n                        popup.destroy();\r\n                    });\r\n                    scriptPopup.setEvent('close', () => {});\r\n                })\r\n                .catch(() => {\r\n                    scriptPopup.message('支付时发生错误!\\n请稍后再试...');\r\n                    scriptPopup.setEvent('close', () => {});\r\n                })\r\n            ;\r\n        });\r\n        scriptPopup.setEvent('close', () => {});\r\n    }\r\n\r\n\r\n    close() {\r\n        this.node.destroy();\r\n    }\r\n}\r\n"]}