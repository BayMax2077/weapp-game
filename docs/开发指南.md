# 微信小游戏开发指南

**最后更新**: 2025-10-21  
**项目状态**: ✅ 游戏迁移完成，功能开发完成，纯小游戏模式架构稳定，准备测试和上线

## 开发环境搭建

### 1. 环境要求 ✅
- **Node.js**: 18.0+ LTS ✅ (已安装 v24.9.0)
- **微信开发者工具**: 最新稳定版 ✅ (已配置)
- **Cocos Creator**: 3.8+ (用于游戏引擎开发) ✅ (已配置)
- **MongoDB**: 数据库 (可选，支持内存存储) ⚠️ (可选)
- **Redis**: 缓存 (可选，支持内存存储) ⚠️ (可选)
- **Git**: 版本控制 ✅ (已配置)

### 2. 微信开发者工具配置

#### 2.1 安装与登录
- 下载微信开发者工具稳定版
- 使用微信扫码登录
- 准备测试号 AppID（微信公众平台测试号）

#### 2.2 项目配置
```json
// project.config.json 配置示例
{
  "setting": {
    "es6": true,
    "postcss": true,
    "minified": true,
    "enhance": true,
    "uploadWithSourceMap": true,
    "minifyWXSS": true,
    "minifyWXML": true
  },
  "compileType": "game",
  "appid": "你的测试号AppID",
  "libVersion": "3.10.3"
}
```

#### 2.3 小游戏配置
```json
// game.json 配置
{
  "deviceOrientation": "portrait",
  "showStatusBar": true,
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000
  }
}
```

### 3. 快速开始 (推荐) ✅
```bash
# 进入项目目录
cd weapp-game-v2

# 安装依赖 ✅
npm install

# 配置环境变量 ✅
copy env.example .env

# 启动后端服务 (无需数据库) ✅
npm run dev

# 验证服务启动 ✅
# 访问: http://localhost:3000/health
# 预期响应: {"status":"ok","timestamp":1760900354403,"rooms":0,"connections":0}
```

### 4. 微信小游戏开发流程

#### 4.1 创建小游戏项目
1. 打开微信开发者工具
2. 选择"新建项目" → "小游戏"
3. 填写项目信息：
   - AppID: 测试号 AppID
   - 项目名称: weapp-game-v2
   - 开发目录: 选择 `weapp-game-v2/miniprogram`
4. 点击"新建"

#### 4.2 基础文件结构
```
miniprogram/
├── game.js          # 小游戏入口文件
├── game.json        # 小游戏配置文件
├── project.config.json  # 项目配置文件
├── utils/           # 工具函数
│   ├── api.js       # API接口
│   ├── socket.js    # Socket.IO连接
│   ├── ad.js        # 广告相关
│   └── payment.js   # 支付相关
└── assets/          # 资源文件
```

#### 4.3 小游戏入口文件 (game.js)
```javascript
// 小游戏入口文件
import './utils/api.js';
import './utils/socket.js';

// 小游戏生命周期
App({
  onLaunch(options) {
    console.log('小游戏启动', options);
    // 初始化游戏
    this.initGame();
  },

  onShow(options) {
    console.log('小游戏显示', options);
  },

  onHide() {
    console.log('小游戏隐藏');
  },

  onError(error) {
    console.error('小游戏错误', error);
  },

  // 初始化游戏
  initGame() {
    // 游戏初始化逻辑
    console.log('游戏初始化完成');
  }
});
```

### 5. 完整环境搭建 (含数据库)

#### 5.1 安装MongoDB
```bash
# 方法1: 下载MongoDB Community Server
# 访问: https://www.mongodb.com/try/download/community
# 下载Windows版本并安装

# 方法2: 使用Docker (推荐)
docker run -d -p 27017:27017 --name mongodb mongo:latest

# 方法3: 使用Chocolatey
choco install mongodb
```

#### 5.2 安装Redis
```bash
# 方法1: 使用Docker (推荐)
docker run -d -p 6379:6379 --name redis redis:latest

# 方法2: 使用Chocolatey (需要管理员权限)
choco install redis-64

# 方法3: 使用Scoop (用户级安装)
scoop install redis

# 方法4: 直接下载Windows版本
# 访问: https://github.com/microsoftarchive/redis/releases
# 下载Windows版本并安装

# 方法5: 使用WSL2 (推荐用于开发)
wsl --install -d Ubuntu
# 然后在WSL中安装: sudo apt install redis-server

# 方法6: 无需安装Redis服务器 (推荐用于开发)
# 项目已配置Redis客户端，支持优雅降级到内存存储
# 当Redis不可用时，自动使用内存存储，不影响开发
```

#### 5.3 配置数据库连接
```bash
# 编辑 .env 文件
MONGODB_URI=mongodb://localhost:27017/weapp_game_v2
REDIS_HOST=localhost
REDIS_PORT=6379

# 初始化数据库
npm run init-db
```

#### 5.4 验证数据库连接
```bash
# 启动服务
npm run dev

# 测试API接口
curl http://localhost:3000/api/game/list
```

### 6. 微信小游戏核心能力

#### 6.1 用户信息与登录
```javascript
// 用户登录
wx.login({
  success: (res) => {
    if (res.code) {
      // 发送 res.code 到后台换取 openId, sessionKey, unionId
      console.log('登录成功', res.code);
    }
  }
});

// 获取用户信息
wx.getUserInfo({
  success: (res) => {
    console.log('用户信息', res.userInfo);
  }
});
```

#### 6.2 网络请求
```javascript
// HTTP请求
wx.request({
  url: 'http://localhost:3000/api/game/list',
  method: 'GET',
  success: (res) => {
    console.log('请求成功', res.data);
  },
  fail: (err) => {
    console.error('请求失败', err);
  }
});
```

#### 6.3 本地存储
```javascript
// 存储数据
wx.setStorageSync('gameData', {
  level: 1,
  score: 1000,
  coins: 50
});

// 读取数据
const gameData = wx.getStorageSync('gameData');
console.log('游戏数据', gameData);
```

#### 6.4 音频播放
```javascript
// 创建音频上下文
const audioContext = wx.createInnerAudioContext();
audioContext.src = 'assets/audio/bgm.mp3';
audioContext.loop = true;
audioContext.play();

// 播放音效
const soundEffect = wx.createInnerAudioContext();
soundEffect.src = 'assets/audio/jump.mp3';
soundEffect.play();
```

#### 6.5 分享功能
```javascript
// 分享到聊天
wx.shareAppMessage({
  title: '一起来玩游戏吧！',
  imageUrl: 'assets/images/share.jpg',
  query: 'roomId=123'
});

// 分享到朋友圈
wx.shareTimeline({
  title: '我在游戏中获得了高分！',
  imageUrl: 'assets/images/score.jpg'
});
```

#### 6.6 广告能力
```javascript
// 激励视频广告
const rewardedVideoAd = wx.createRewardedVideoAd({
  adUnitId: 'your-ad-unit-id'
});

rewardedVideoAd.onClose((res) => {
  if (res && res.isEnded) {
    // 用户看完了广告，给予奖励
    console.log('用户获得奖励');
  }
});

// 显示广告
rewardedVideoAd.show();
```

#### 6.7 虚拟支付
```javascript
// 发起支付
wx.requestPayment({
  timeStamp: String(Date.now()),
  nonceStr: 'random-string',
  package: 'prepay_id=wx123456789',
  signType: 'MD5',
  paySign: 'signature',
  success: (res) => {
    console.log('支付成功', res);
  },
  fail: (err) => {
    console.error('支付失败', err);
  }
});
```

### 7. 开发工具配置
- 配置微信开发者工具
- 设置API接口地址: `http://localhost:3000`
- 配置Socket.IO连接: `http://localhost:3000`
- 数据库连接 (可选)

### 8. Redis安装测试结果 (2025-10-20) ✅
经过测试，以下Redis安装方案的结果：

#### ✅ 成功方案
- **Node.js Redis客户端方案** (推荐用于开发) ✅
  - 无需安装Redis服务器 ✅
  - 项目已配置优雅降级处理 ✅
  - 当Redis不可用时，自动使用内存存储 ✅
  - 服务正常运行在端口3000 ✅

#### ❌ 失败方案
- Docker方案: Docker未安装
- Chocolatey方案: 需要管理员权限
- Scoop方案: 网络连接问题
- 直接下载方案: 网络连接问题
- WSL2方案: 需要额外配置

#### 当前项目状态 ✅
- ✅ 后端服务正常运行: `http://localhost:3000`
- ✅ 健康检查通过: `/health` 接口正常
- ✅ Redis客户端已安装: 支持优雅降级
- ✅ 内存存储正常工作: 无需外部依赖
- ✅ 4个完整游戏实现: 消消乐、飞行棋、四张牌、五子棋
- ✅ 现代化UI设计: 现代设计语言，响应式布局
- ✅ 统一游戏引擎: 自研GameEngine
- ✅ 完善工具类库: 游戏工具、配置、验证等

### 9. 微信小游戏调试技巧

#### 9.1 调试工具使用
```javascript
// 使用 vConsole 调试
// 在微信开发者工具中，点击"调试" → "vConsole"

// 使用断点调试
debugger;

// 使用 console 调试
console.log('调试信息', data);
console.error('错误信息', error);
console.warn('警告信息', warning);
```

#### 9.2 真机调试
1. 在微信开发者工具中点击"真机调试"
2. 使用手机微信扫描二维码
3. 在手机上查看调试信息

#### 9.3 性能调试
```javascript
// 性能监控
const startTime = Date.now();
// 执行代码
const endTime = Date.now();
console.log('执行时间:', endTime - startTime, 'ms');

// 内存使用监控
console.log('内存使用:', wx.getSystemInfoSync().memory);
```

### 10. 微信小游戏发布流程

#### 10.1 代码上传
1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 上传代码到微信后台

#### 10.2 提交审核
1. 登录微信公众平台
2. 进入"开发管理" → "开发版本"
3. 点击"提交审核"
4. 填写审核信息

#### 10.3 发布上线
1. 审核通过后，点击"发布"
2. 小游戏正式上线

### 11. 常见问题解决

#### 11.1 小游戏启动问题
```javascript
// 检查小游戏配置
console.log('小游戏配置:', wx.getSystemInfoSync());

// 检查网络状态
wx.getNetworkType({
  success: (res) => {
    console.log('网络类型:', res.networkType);
  }
});
```

#### 11.2 性能优化
- 使用对象池管理游戏对象
- 合理使用内存，及时释放资源
- 优化图片资源大小
- 使用分包加载减少首屏加载时间

#### 11.3 兼容性问题
```javascript
// 检查基础库版本
const systemInfo = wx.getSystemInfoSync();
console.log('基础库版本:', systemInfo.SDKVersion);

// 版本兼容处理
if (wx.canIUse('createRewardedVideoAd')) {
  // 支持激励视频广告
} else {
  // 降级处理
}
```

## 代码规范

### 12. JavaScript规范
```javascript
// 使用ES6+语法
class GameManager {
    constructor() {
        this.gameData = null;
        this.isRunning = false;
    }
    
    /**
     * 游戏开始
     * @param {Object} data 游戏数据
     */
    startGame(data) {
        this.gameData = data;
        this.isRunning = true;
        // 实现逻辑
    }
}
```

### 13. 文件命名规范
- **脚本文件**: 使用camelCase，如 `gameManager.js`
- **页面文件**: 使用camelCase，如 `gamePage.js`
- **工具文件**: 使用camelCase，如 `apiUtils.js`

### 14. 目录结构规范
```
miniprogram/
├── pages/           # 页面
├── components/      # 组件
├── utils/           # 工具函数
├── assets/          # 资源文件
└── app.js           # 小程序入口
```

## 开发流程

### 15. 新功能开发
1. **需求分析**: 明确功能需求和技术方案
2. **设计阶段**: 设计UI界面和交互逻辑
3. **编码实现**: 按照代码规范进行开发
4. **测试验证**: 功能测试和性能测试
5. **代码审查**: 团队代码审查
6. **部署发布**: 构建和发布

### 16. 游戏开发流程
1. **游戏设计**: 确定游戏规则和玩法
2. **场景搭建**: 在Cocos Creator 3.8+中创建场景
3. **脚本编写**: 实现游戏逻辑
4. **资源集成**: 添加音效、图片等资源
5. **测试调试**: 功能测试和bug修复
6. **优化发布**: 性能优化和最终发布

## 调试技巧

### 17. 微信小程序调试
```javascript
// 使用console.log进行调试
console.log('游戏状态:', gameState);

// 使用断点调试
debugger;

// 使用微信开发者工具的调试工具
wx.showToast({
    title: '调试信息',
    icon: 'none'
});
```

### 18. 网络调试
```javascript
// Socket.IO事件监听
socket.on('gameData', (data) => {
    console.log('接收到游戏数据:', data);
});

// HTTP请求调试
api.getRoomInfo(roomCode).then(res => {
    console.log('房间信息:', res);
});
```

### 19. 性能调试
- 使用微信开发者工具的性能分析器
- 监控内存使用情况
- 检查渲染性能

## 常见问题解决

### 20. 构建问题
```bash
# 清理构建缓存
rm -rf build/
rm -rf temp/

# 重新构建
npm run build
```

### 21. 依赖问题
```bash
# 清理node_modules
rm -rf node_modules/
rm package-lock.json

# 重新安装
npm install
```

### 22. 微信小程序问题
- 检查微信开发者工具版本
- 确认小程序配置正确
- 检查网络请求域名配置
- 检查Socket连接域名配置

## 部署指南

### 23. 开发环境部署
```bash
# 启动后端服务
npm run dev

# 使用微信开发者工具打开 miniprogram 目录
```

### 24. 生产环境部署
```bash
# Docker部署
docker build -t weapp-game .
docker run -p 3000:3000 weapp-game

# PM2部署
pm2 start server/app.js --name weapp-game
```

### 25. 微信小程序部署
1. 使用微信开发者工具打开 miniprogram 目录
2. 上传代码到微信后台
3. 提交审核
4. 发布上线

## 版本管理

### 26. Git工作流
```bash
# 创建功能分支
git checkout -b feature/new-game

# 提交代码
git add .
git commit -m "feat: 添加新游戏功能"

# 合并到主分支
git checkout main
git merge feature/new-game
```

### 27. 版本号管理
- 使用语义化版本号 (SemVer)
- 主版本号：重大功能更新
- 次版本号：新功能添加
- 修订号：bug修复

### 28. 发布流程
1. 更新版本号
2. 更新CHANGELOG
3. 创建发布标签
4. 部署到生产环境

## 测试验证

### 29. 服务健康检查 ✅
```bash
# 检查服务状态 ✅
curl http://localhost:3000/health

# 预期响应 ✅
{
  "status": "ok",
  "timestamp": 1760897768131,
  "rooms": 0,
  "connections": 0
}
```

### 30. API接口测试 ✅
```bash
# 测试用户接口 ✅
curl -X POST http://localhost:3000/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456","verifyCode":"123456"}'

# 测试游戏接口 ✅
curl http://localhost:3000/api/game/list

# 测试房间接口 ✅
curl http://localhost:3000/api/room/random?gameId=flight_chess
```

### 31. Socket.IO连接测试 ✅
```javascript
// 在浏览器控制台测试 ✅
const socket = io('http://localhost:3000');
socket.on('connect', () => console.log('Socket连接成功'));
```

## 团队协作

### 32. 代码审查
- 所有代码必须经过审查
- 使用Pull Request进行代码合并
- 建立代码审查清单

### 33. 文档维护
- 及时更新技术文档
- 记录重要的技术决策
- 维护API文档

### 34. 测试策略
- 单元测试：核心逻辑测试
- 集成测试：模块间交互测试
- 端到端测试：完整流程测试

## 总结

微信小游戏开发指南涵盖了从环境搭建到发布上线的完整流程。基于微信小游戏开发指南和项目实际情况，本指南提供了：

### 核心要点 ✅
1. **环境配置**：微信开发者工具 + 测试号 AppID + 后端服务 ✅
2. **开发流程**：小游戏项目创建 → 核心能力集成 → 调试测试 → 发布上线 ✅
3. **核心能力**：用户登录、网络请求、本地存储、音频播放、分享功能、广告变现、虚拟支付 ✅
4. **调试技巧**：vConsole调试、真机调试、性能监控 ✅
5. **发布流程**：代码上传 → 提交审核 → 发布上线 ✅

### 技术栈 ✅
- **前端**：微信小游戏 + JavaScript ES6+ ✅
- **后端**：Node.js + Express + Socket.IO ✅
- **数据库**：MongoDB + Redis（支持优雅降级） ✅
- **开发工具**：微信开发者工具 + Cocos Creator ✅

### 最佳实践 ✅
- 使用测试号进行开发调试 ✅
- 合理使用小游戏核心能力 ✅
- 注重性能优化和用户体验 ✅
- 遵循微信小游戏开发规范 ✅

### 项目完成情况 ✅
- ✅ 4个完整游戏实现 (消消乐、飞行棋、四张牌、五子棋)
- ✅ 现代化UI设计 (现代设计语言，响应式布局)
- ✅ 统一游戏引擎 (自研GameEngine)
- ✅ 完善工具类库 (游戏工具、配置、验证等)
- ✅ 后端服务架构 (Node.js + Express.js)
- ✅ API接口系统 (用户、游戏、房间、支付等)
- ✅ Socket.IO实时通信 (实时数据同步)
- ✅ 纯小游戏模式架构 (SceneManager + BaseScene)
- ✅ 自定义UI组件系统 (ModernButton、ModernCard、ProgressBar、Tag、SearchBox、NavigationBar)
- ✅ Jest测试框架集成 (单元测试、集成测试、覆盖率报告)
- ✅ 完整的API接口系统 (进度管理、搜索、收藏、排行榜)

通过本指南，开发者可以快速上手微信小游戏开发，构建高质量的游戏平台。

---

**文档更新时间**: 2024-12-19  
**项目状态**: ✅ 游戏迁移完成，功能开发完成，准备测试和上线  
**下一步**: 项目测试验证和性能优化
