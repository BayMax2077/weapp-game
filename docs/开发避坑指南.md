# 微信小游戏开发避坑指南

## 📋 概述

基于2025-10-21的测试问题记录，总结微信小游戏开发中的常见问题和解决方案，为后续开发提供指导。

## 🚨 关键问题总结

### 1. 项目类型配置问题 ⚠️ 高优先级

**问题现象**：
- `ReferenceError: Game is not defined`
- `ReferenceError: App is not defined`
- 真机调试报错：非法的文件

**根本原因**：
- 微信小游戏和小程序是两种不同的项目类型
- 不能混合使用，必须明确选择一种类型

**解决方案**：
```json
// project.config.json
{
  "compileType": "game",  // 小游戏模式
  "libVersion": "2.19.6"  // 推荐基础库版本
}
```

**避坑要点**：
- ✅ 小游戏：`compileType: "game"`，使用 `game.js` + `game.json`
- ✅ 小程序：`compileType: "miniprogram"`，使用 `app.js` + `app.json`
- ❌ 不能混合使用两种模式

### 2. 基础库版本兼容性问题 ⚠️ 高优先级

**问题现象**：
- `ReferenceError: Game is not defined`
- 某些API不支持

**根本原因**：
- 基础库版本过新或过旧
- API兼容性问题

**解决方案**：
- 推荐使用 `2.19.6` 版本
- 避免使用 `3.10.3` 等过新版本
- 在微信开发者工具中设置正确的基础库版本

**避坑要点**：
- ✅ 使用稳定的基础库版本
- ✅ 测试不同基础库版本的兼容性
- ❌ 避免使用过新的基础库版本

### 3. 文件编码问题 ⚠️ 中优先级

**问题现象**：
- `SyntaxError: Unexpected token ﻿ in JSON at position 0`
- JSON解析失败

**根本原因**：
- JSON文件包含UTF-8 BOM（字节序标记）
- 文件编码格式不正确

**解决方案**：
- 使用UTF-8无BOM编码保存所有JSON文件
- 确保文件开头直接是`{`字符
- 使用文本编辑器检查文件编码

**避坑要点**：
- ✅ 所有JSON文件使用UTF-8无BOM编码
- ✅ 检查文件开头是否有隐藏字符
- ❌ 避免在JSON文件中添加BOM标记

### 4. 样式文件问题 ⚠️ 中优先级

**问题现象**：
- 真机调试报错：非法的文件
- 样式不生效

**根本原因**：
- 使用了微信小游戏不支持的CSS语法
- 文件结构不符合规范

**解决方案**：
- 避免使用CSS变量
- 不要创建`game.wxss`文件
- 简化全局样式文件

**避坑要点**：
- ✅ 使用具体的CSS值，避免CSS变量
- ✅ 简化样式文件结构
- ❌ 避免使用复杂的CSS语法

### 5. 模块系统问题 ⚠️ 中优先级

**问题现象**：
- `SyntaxError: Cannot use import statement outside a module`
- 模块加载失败

**根本原因**：
- 使用了ES6的import/export语法
- 微信小游戏不支持ES6模块

**解决方案**：
- 使用CommonJS的require/module.exports
- 确保所有模块正确导出和导入
- 避免循环依赖

**避坑要点**：
- ✅ 使用`require()`和`module.exports`
- ✅ 确保模块正确导出
- ❌ 避免使用ES6的import/export

### 6. Canvas API兼容性问题 ⚠️ 中优先级

**问题现象**：
- `TypeError: Mc is not a function`
- Canvas绘制失败

**根本原因**：
- 使用了不兼容的Canvas API
- 基础库版本不支持某些API

**解决方案**：
- 使用兼容性更好的API
- 为不支持的API提供fallback方案
- 测试不同基础库版本的兼容性

**避坑要点**：
- ✅ 使用`arcTo()`代替`roundRect()`
- ✅ 为不支持的API提供fallback
- ❌ 避免使用过新的Canvas API

## 🛠️ 开发最佳实践

### 1. 项目初始化
```bash
# 1. 选择正确的项目类型
# 小游戏：compileType: "game"
# 小程序：compileType: "miniprogram"

# 2. 设置正确的基础库版本
"libVersion": "2.19.6"

# 3. 使用正确的文件结构
# 小游戏：game.js + game.json
# 小程序：app.js + app.json
```

### 2. 文件编码规范
```bash
# 所有文件使用UTF-8无BOM编码
# 检查文件编码：
# - 使用文本编辑器查看
# - 确保JSON文件开头是{字符
# - 避免隐藏字符
```

### 3. 模块系统规范
```javascript
// ✅ 正确：使用CommonJS
const Module = require('./Module');
module.exports = MyClass;

// ❌ 错误：使用ES6模块
import Module from './Module';
export default MyClass;
```

### 4. Canvas API规范
```javascript
// ✅ 正确：使用兼容的API
function drawRoundedRect(ctx, x, y, width, height, radius) {
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.arcTo(x + width, y, x + width, y + radius, radius);
  // ... 使用arcTo绘制圆角
}

// ❌ 错误：使用不兼容的API
ctx.roundRect(x, y, width, height, radius);
```

### 5. 样式文件规范
```css
/* ✅ 正确：使用具体值 */
.button {
  background-color: #3b82f6;
  border-radius: 8px;
}

/* ❌ 错误：使用CSS变量 */
.button {
  background-color: var(--primary-color);
  border-radius: var(--border-radius);
}
```

## 🔍 调试技巧

### 1. 真机调试
- 使用微信开发者工具的真机调试功能
- 检查控制台错误信息
- 验证文件路径和编码

### 2. 基础库测试
- 测试不同基础库版本的兼容性
- 使用稳定的基础库版本
- 避免使用过新的API

### 3. 文件检查
- 检查文件编码格式
- 验证JSON文件格式
- 确保文件路径正确

## 📝 问题排查流程

1. **确认项目类型**：检查`compileType`设置
2. **检查基础库版本**：使用稳定的版本
3. **验证文件编码**：确保UTF-8无BOM
4. **检查模块系统**：使用CommonJS语法
5. **测试Canvas API**：使用兼容的API
6. **验证样式文件**：避免复杂语法

## 🎯 总结

通过本次测试，我们发现了微信小游戏开发中的关键问题：

1. **项目类型选择**是最重要的问题，必须明确选择小游戏或小程序
2. **基础库版本**对兼容性影响很大，推荐使用稳定版本
3. **文件编码**问题容易被忽视，但会导致严重错误
4. **模块系统**必须使用CommonJS，不能使用ES6模块
5. **Canvas API**需要兼容性考虑，避免使用过新的API

遵循这些避坑指南，可以大大减少开发过程中的问题，提高开发效率。

---

**文档更新时间**: 2025-10-21  
**适用版本**: 微信小游戏基础库 2.19.6+  
**维护状态**: 持续更新
